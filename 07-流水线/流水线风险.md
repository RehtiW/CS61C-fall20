![[Pasted image 20250109173232.png]]
## 结构风险-structural hazard
1.所需物理硬件繁忙,
Two or more instructions in the pipeline compete for access to a single physical resource
2.指令内存和数据内存同时访问
### 解决方案:
1.指令轮流使用资源,某些指令会被阻塞
2.增设更多硬件
3.在内存块中将指令和数据分隔开
4.caches
5.RISCV指令集架构因为其模块化设计,缓解了结构风险
### 寄存器文件结构风险
**原因:**
每个指令可以至多在解码阶段读取两个操作数
在写回阶段写回一个值
**解决方案:**
拥有两个独立的读取端口,一个独立的写入端口,所以这三个访问操作可以在同一时钟周期内同时进行
## 数据风险-data hazard
后一个指令的操作依赖于前一个指令的结果:
比如**分支条件判断**,**连续运算**,**加载数据**
### 判断依据:
**比较早期指令的目标寄存器和新指令的源寄存器**，目的是检查是否存在数据冒险
### 解决方案(ALU Result):
#### 方案一:加入空泡(图例左边填充则写入,右边填充则读取),两周其空泡
![[Pasted image 20241219210819.png]]
拖延降低性能,编译器通过插入空操作实现停顿,导致性能下降
![[Pasted image 20241219210945.png]]
#### 方案二:数据转发
从流水线中获得操作数，而不是从寄存器文件
即使前一条指令没有写回结果，后续指令也可以通过从执行阶段（EX）或内存阶段（MEM）直接获取数据
![[Pasted image 20241219211452.png]]

### 解决方案(Load Data Hazard):
#### 1.stall pipeline
s2数据直到4th阶段才会得到,但第二条指令此时已经过了decode和ex阶段,所以无法数据转发,必须插入一个空泡
![[Pasted image 20241221115044.png]]
#### 2.Code Scheduling to Avoid Stalls
通过重排列先执行相互无关项
![[Pasted image 20241221115552.png]]
## 控制风险-control hazard
**有关B类型指令**
### 解决方案:
#### 1.
B类型指令在**3th-EX阶段才得到分支比较结果并计算PC偏移结果**
若跳转
则第四条指令对应的PC指向Label,**前面两条指令应当作废,转化为nop,**
若不跳转
则照常+4
![[Pasted image 20241221115813.png]]
#### 2.
这导致每一执行跳转的B指令导致2个作废的周期,为了增强性能,推出分支预测功能
这里举-**单位历史表（1-bit predictor）**
 假设此时预测位为1即跳转,处理器会取出跳转目标的指令
 两个周期后B指令执行完EX阶段,得以有机会证明是否预测成功
 若成功则无事发生,若预测失败则将预测为置0,将前两条指令设为nops
#### ![[Pasted image 20241221120517.png]]


## 流水线CPU数据通路
(注意每个阶段之间的通路包含寄存器;数据转发控制逻辑,判断是否需要数据转发)
![[Screenshot 2024-12-19 211754.png]]