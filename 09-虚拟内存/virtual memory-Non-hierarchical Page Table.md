**非分级页表**（Non-hierarchical Page Table）是虚拟内存管理的一种简单方式，通常用于较小的虚拟地址空间。在多个进程的情况下，非分级页表的工作原理与上下文切换密切相关。在这种情况下，每个进程有一个独立的页表，操作系统通过切换页表来实现不同进程的虚拟内存映射，从而保证进程之间的隔离。
# 内存等级制度
![[Pasted image 20250105170025.png]]

**虚拟内存给进程一个独自使用所有内存的错觉**

# 虚拟内存框图
进程使用虚拟地址，内存使用物理地址，内存管理器将虚拟地址映射到物理地址
![[Pasted image 20250105170200.png]]

# 虚拟内存
**虚拟内存被组织为一个**由**存放在磁盘**上的N个**连续的字节大小的单元组成的数组**
每个字节都有唯一的虚拟地址
**和存储器层次结构中其他缓存一样**，磁盘(较低层)上的**数据被分割成块**,作为磁盘和主存(较高层)之间的传输单元
### 虚拟页和物理页
**虚拟内存系统通过将虚拟内存分割为大小固定的块:虚拟页(Virtual Page,VP)**
**类似的，物理内存被分割为物理页(Physical Page,PP)**,大小都为P字节
### 在任意时刻,虚拟页面的集合分为三个不相交的子集:
- **未分配的：VM 系统还未分配（或者创建）的页。未分配的块没有任何数据和它们相关联，因此也就不占用任何磁盘空间。
    
- **缓存的：当前已缓存在物理内存中的已分配页。
    
- **未缓存的：未缓存在物理内存中的已分配页。

# DRAM缓存的组织结构
为了有助于清晰理解存储层次结构中不同的缓存概念，我们将使用术语 **SRAM 缓存**来表示位于 CPU 和主存之间的 Ll、L2 和 L3 高速缓存，并且用术语 **DRAM 缓存来表示虚拟内存系统的缓存，它在主存中缓存虚拟页。**

**因为大的不命中处罚和访问第一个字节的开销，虚拟页往往很大**，通常是 4KB ~ 2MB。
**由于大的不命中处罚，DRAM 缓存是全相联的**，即任何虚拟页都可以放置在任何的物理页中。
不命中时的替换策略也很重要，因为替换错了虚拟页的处罚也非常之高。因此，与硬件对 SRAM 缓存相比，操作系统对 DRAM 缓存使用了更复杂精密的替换算法。（这些替换算法超出了我们的讨论范围）。
**最后，因为对磁盘的访问时间很长，DRAM 缓存总是使用写回，而不是直写。**

# 页表
### 作用
同任何缓存一样，虚拟内存系统必须有某种方法来判定一个虚拟页是否缓存在 DRAM 中的某个地方。
如果是，系统还必须确定这个虚拟页存放在哪个物理页中。
如果不命中，系统必须判断这个虚拟页存放在磁盘的哪个位置，在物理内存中选择一个牺牲页，并将虚拟页从磁盘复制到 DRAM 中，替换这个牺牲页。
### 原理
这些功能是由软硬件联合提供的，包括**操作系统软件、MMU（内存管理单元）中的地址翻译硬件和一个存放在物理内存中叫做页表（page table）的数据结构**，
**页表将虚拟页映射到物理页**。每次**地址翻译硬件将一个虚拟地址转换为物理地址时，都会读取页表**。
操作系统负责维护页表的内容，以及在磁盘与 DRAM 之间来回传送页。

### 页表内容
**页表就是一个页表条目（Page Table Entry，PTE）的数组**。虚拟地址空间中的每个页在页表中一个固定偏移量处都有一个 PTE。
为了我们的目的，我们将假设每个 PTE 是由一个有效位（valid bit）和一个 n 位地址字段组成的。
**有效位表明了该虚拟页当前是否被缓存在 DRAM 中**。
**如果设置了有效位**，那么地址字段就表示 **DRAM 中相应的物理页的起始位置**，这个物理页中缓存了该虚拟页。
**如果没有设置有效位**，那么一个空地址表示这个虚拟页还未被分配。否则，这个地址就**指向该虚拟页在磁盘上的起始位置。**

**页表条目可以缓存在缓存中**
# 页命中
![[Pasted image 20250110202119.png]]

# 缺页
缺页异常是程序在**访问虚拟内存时**，操作系统发现该**虚拟内存页没有映射到物理内存（即该虚拟页面尚未加载到内存中）时，触发的一个异常。具体来说，缺页发生时，CPU会产生一个中断，通知操作系统程序试图访问的页面不存在于物理内存中。

# 地址翻译
![[Pasted image 20250110233604.png]]





